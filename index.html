<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reflex</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0f0f1a;
    --surface: #1a1a2e;
    --border: #2a2a4a;
    --text: #e0e0e0;
    --text-dim: #888;
    --accent: #7c5cfc;
    --correct: #22c55e;
    --wrong: #ef4444;
    --token: #facc15;
  }

  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    user-select: none;
    overflow: hidden;
  }

  h1 {
    font-size: 2.4rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 0.3rem;
  }

  /* ---------- Stats bar ---------- */
  .stats {
    display: flex;
    gap: 2rem;
    font-size: 0.95rem;
    color: var(--text-dim);
    margin-bottom: 1.5rem;
  }
  .stats span { font-variant-numeric: tabular-nums; }
  .stats .value { color: var(--text); font-weight: 600; }

  /* ---------- Arena ---------- */
  .arena {
    display: flex;
    gap: 2rem;
    margin-bottom: 1.5rem;
  }

  .slot {
    width: 140px;
    height: 140px;
    border: 2px solid var(--border);
    border-radius: 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: var(--surface);
    position: relative;
    transition: border-color 0.15s, box-shadow 0.15s;
  }

  .slot .key-label {
    position: absolute;
    bottom: 10px;
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text-dim);
    letter-spacing: 0.1em;
  }

  .slot .token {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--token);
    opacity: 0;
    transform: scale(0.3);
    transition: opacity 0.1s, transform 0.1s;
    box-shadow: 0 0 20px rgba(250, 204, 21, 0.4);
  }

  .slot.active .token {
    opacity: 1;
    transform: scale(1);
  }

  /* Feedback flash */
  .slot.flash-correct {
    border-color: var(--correct);
    box-shadow: 0 0 24px rgba(34, 197, 94, 0.35);
  }
  .slot.flash-wrong {
    border-color: var(--wrong);
    box-shadow: 0 0 24px rgba(239, 68, 68, 0.35);
  }

  /* ---------- Feedback ---------- */
  .feedback {
    font-size: 1rem;
    height: 1.5rem;
    margin-bottom: 1.5rem;
    font-weight: 600;
    transition: opacity 0.2s;
  }
  .feedback.correct { color: var(--correct); }
  .feedback.wrong   { color: var(--wrong); }
  .feedback.miss    { color: var(--wrong); }

  /* ---------- Timer bar ---------- */
  .timer-bar-container {
    width: 460px;
    height: 6px;
    background: var(--surface);
    border-radius: 3px;
    margin-bottom: 2rem;
    overflow: hidden;
  }
  .timer-bar {
    height: 100%;
    width: 100%;
    background: var(--accent);
    border-radius: 3px;
    transform-origin: left;
    transition: background 0.2s;
  }
  .timer-bar.urgent { background: var(--wrong); }

  /* ---------- Buttons ---------- */
  .actions { display: flex; gap: 1rem; margin-bottom: 1rem; }

  button {
    padding: 0.6rem 1.6rem;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.15s, transform 0.1s;
  }
  button:active { transform: scale(0.96); }

  .btn-primary {
    background: var(--accent);
    color: #fff;
  }
  .btn-primary:hover { background: #6a4ae0; }

  .btn-secondary {
    background: var(--surface);
    color: var(--text);
    border: 1px solid var(--border);
  }
  .btn-secondary:hover { background: var(--border); }

  /* ---------- Settings panel ---------- */
  .settings-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    align-items: center;
    justify-content: center;
    z-index: 100;
  }
  .settings-overlay.open { display: flex; }

  .settings-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 2rem;
    width: 400px;
    max-height: 80vh;
    overflow-y: auto;
  }
  .settings-panel h2 {
    font-size: 1.3rem;
    margin-bottom: 1.2rem;
    color: var(--accent);
  }

  .setting-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.8rem;
  }
  .setting-row label {
    font-size: 0.85rem;
    color: var(--text-dim);
  }
  .setting-row input {
    width: 90px;
    padding: 0.3rem 0.5rem;
    font-size: 0.9rem;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--bg);
    color: var(--text);
    text-align: right;
  }

  .settings-actions {
    display: flex;
    gap: 0.8rem;
    margin-top: 1.2rem;
    justify-content: flex-end;
  }

  /* ---------- Game-over overlay ---------- */
  .gameover-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    align-items: center;
    justify-content: center;
    z-index: 90;
  }
  .gameover-overlay.open { display: flex; }

  .gameover-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 2.5rem;
    width: 380px;
    text-align: center;
  }
  .gameover-panel h2 {
    font-size: 1.6rem;
    color: var(--accent);
    margin-bottom: 1.2rem;
  }
  .gameover-stat {
    display: flex;
    justify-content: space-between;
    padding: 0.4rem 0;
    border-bottom: 1px solid var(--border);
    font-size: 0.95rem;
  }
  .gameover-stat:last-of-type { border-bottom: none; }
  .gameover-stat .label { color: var(--text-dim); }
  .gameover-stat .val { font-weight: 700; }

  .gameover-actions { margin-top: 1.5rem; }

  /* ---------- Responsive ---------- */
  @media (max-width: 520px) {
    .arena { gap: 0.8rem; }
    .slot { width: 100px; height: 100px; }
    .slot .token { width: 36px; height: 36px; }
    .timer-bar-container { width: 90vw; }
    .stats { gap: 1rem; font-size: 0.85rem; }
  }
</style>
</head>
<body>

<h1>Reflex</h1>

<div class="stats">
  <span>Score: <span class="value" id="score">0</span></span>
  <span>Round: <span class="value" id="round">0/20</span></span>
  <span>Speed: <span class="value" id="lifetime">3000</span> ms</span>
</div>

<div class="arena">
  <div class="slot" data-pos="0">
    <div class="token"></div>
    <span class="key-label">A</span>
  </div>
  <div class="slot" data-pos="1">
    <div class="token"></div>
    <span class="key-label">S</span>
  </div>
  <div class="slot" data-pos="2">
    <div class="token"></div>
    <span class="key-label">D</span>
  </div>
</div>

<div class="timer-bar-container">
  <div class="timer-bar" id="timerBar"></div>
</div>

<div class="feedback" id="feedback">&nbsp;</div>

<div class="actions">
  <button class="btn-primary" id="startBtn">Start Game</button>
  <button class="btn-secondary" id="settingsBtn">Settings</button>
</div>

<!-- Settings overlay -->
<div class="settings-overlay" id="settingsOverlay">
  <div class="settings-panel">
    <h2>Settings</h2>
    <div class="setting-row"><label>Base Points</label><input id="cfg-basePoints" type="number"></div>
    <div class="setting-row"><label>Penalty Points</label><input id="cfg-penaltyPoints" type="number"></div>
    <div class="setting-row"><label>Initial Lifetime (ms)</label><input id="cfg-initialLifetime" type="number"></div>
    <div class="setting-row"><label>Min Lifetime (ms)</label><input id="cfg-minLifetime" type="number"></div>
    <div class="setting-row"><label>Max Lifetime (ms)</label><input id="cfg-maxLifetime" type="number"></div>
    <div class="setting-row"><label>Speedup Factor</label><input id="cfg-speedupFactor" type="number" step="0.01"></div>
    <div class="setting-row"><label>Slowdown Factor</label><input id="cfg-slowdownFactor" type="number" step="0.01"></div>
    <div class="setting-row"><label>Inter-round Pause (ms)</label><input id="cfg-interRoundMs" type="number"></div>
    <div class="setting-row"><label>Rounds (0 = endless)</label><input id="cfg-numRounds" type="number"></div>
    <div class="settings-actions">
      <button class="btn-secondary" id="settingsResetBtn">Defaults</button>
      <button class="btn-primary" id="settingsSaveBtn">Save</button>
    </div>
  </div>
</div>

<!-- Game-over overlay -->
<div class="gameover-overlay" id="gameoverOverlay">
  <div class="gameover-panel">
    <h2>Game Over</h2>
    <div class="gameover-stat"><span class="label">Final Score</span><span class="val" id="go-score"></span></div>
    <div class="gameover-stat"><span class="label">Correct</span><span class="val" id="go-correct"></span></div>
    <div class="gameover-stat"><span class="label">Wrong</span><span class="val" id="go-wrong"></span></div>
    <div class="gameover-stat"><span class="label">Missed</span><span class="val" id="go-missed"></span></div>
    <div class="gameover-stat"><span class="label">Accuracy</span><span class="val" id="go-accuracy"></span></div>
    <div class="gameover-stat"><span class="label">Avg Reaction</span><span class="val" id="go-avgTime"></span></div>
    <div class="gameover-actions">
      <button class="btn-primary" id="playAgainBtn">Play Again</button>
    </div>
  </div>
</div>

<script>
// ── Configurable parameters ──────────────────────────────────────
const DEFAULTS = {
  basePoints:      1000,
  penaltyPoints:   500,
  initialLifetime: 3000,
  minLifetime:     400,
  maxLifetime:     5000,
  speedupFactor:   0.90,
  slowdownFactor:  1.20,
  interRoundMs:    500,
  numRounds:       20,
};

let config = { ...DEFAULTS };

// ── DOM refs ─────────────────────────────────────────────────────
const slots        = document.querySelectorAll('.slot');
const scoreEl      = document.getElementById('score');
const roundEl      = document.getElementById('round');
const lifetimeEl   = document.getElementById('lifetime');
const feedbackEl   = document.getElementById('feedback');
const timerBar     = document.getElementById('timerBar');
const startBtn     = document.getElementById('startBtn');
const settingsBtn  = document.getElementById('settingsBtn');
const settingsOvl  = document.getElementById('settingsOverlay');
const settingsSave = document.getElementById('settingsSaveBtn');
const settingsReset= document.getElementById('settingsResetBtn');
const gameoverOvl  = document.getElementById('gameoverOverlay');
const playAgainBtn = document.getElementById('playAgainBtn');

// ── Game state ───────────────────────────────────────────────────
let gameRunning   = false;
let currentRound  = 0;
let totalScore    = 0;
let lifetime      = config.initialLifetime;
let activePos     = -1;   // 0, 1, 2 or -1
let tokenShownAt  = 0;    // performance.now() timestamp
let responded     = false;
let roundTimer    = null;  // timeout for token expiry
let animFrame     = null;  // requestAnimationFrame id
let waitingNext   = false; // inter-round pause

// Stats
let correctCount = 0;
let wrongCount   = 0;
let missCount    = 0;
let reactionTimes = [];    // only correct responses

const KEY_MAP = { a: 0, s: 1, d: 2 };

// ── Settings ─────────────────────────────────────────────────────
function populateSettings() {
  for (const key of Object.keys(DEFAULTS)) {
    document.getElementById('cfg-' + key).value = config[key];
  }
}

function readSettings() {
  for (const key of Object.keys(DEFAULTS)) {
    const raw = document.getElementById('cfg-' + key).value;
    const val = parseFloat(raw);
    if (!isNaN(val)) config[key] = val;
  }
}

settingsBtn.addEventListener('click', () => {
  if (gameRunning) return;
  populateSettings();
  settingsOvl.classList.add('open');
});

settingsSave.addEventListener('click', () => {
  readSettings();
  settingsOvl.classList.remove('open');
});

settingsReset.addEventListener('click', () => {
  config = { ...DEFAULTS };
  populateSettings();
});

settingsOvl.addEventListener('click', (e) => {
  if (e.target === settingsOvl) settingsOvl.classList.remove('open');
});

// ── Timer bar animation ──────────────────────────────────────────
function startTimerBar() {
  const start = performance.now();
  const duration = lifetime;

  function tick() {
    const elapsed = performance.now() - start;
    const pct = Math.max(0, 1 - elapsed / duration);
    timerBar.style.transform = `scaleX(${pct})`;
    timerBar.classList.toggle('urgent', pct < 0.25);
    if (pct > 0 && gameRunning) {
      animFrame = requestAnimationFrame(tick);
    }
  }
  animFrame = requestAnimationFrame(tick);
}

function stopTimerBar() {
  if (animFrame) cancelAnimationFrame(animFrame);
  animFrame = null;
}

// ── Core game logic ──────────────────────────────────────────────
function resetUI() {
  slots.forEach(s => {
    s.classList.remove('active', 'flash-correct', 'flash-wrong');
  });
  feedbackEl.textContent = '\u00a0';
  feedbackEl.className = 'feedback';
  timerBar.style.transform = 'scaleX(1)';
  timerBar.classList.remove('urgent');
}

function showToken() {
  if (!gameRunning) return;

  currentRound++;
  responded = false;
  waitingNext = false;
  activePos = Math.floor(Math.random() * 3);

  // Update display
  updateStats();
  resetUI();
  slots[activePos].classList.add('active');

  tokenShownAt = performance.now();
  startTimerBar();

  // Set expiry timer
  roundTimer = setTimeout(() => onMiss(), lifetime);
}

function onMiss() {
  if (responded || !gameRunning) return;
  responded = true;
  stopTimerBar();

  const elapsed = lifetime; // full duration elapsed
  const points = -config.penaltyPoints * (elapsed / lifetime);
  totalScore += points;
  missCount++;

  showFeedback('miss', points, elapsed);
  flashSlot(activePos, false);
  adjustLifetime(false);
  nextRound();
}

function onKeyResponse(pressedPos) {
  if (!gameRunning || responded || waitingNext || activePos < 0) return;
  responded = true;
  clearTimeout(roundTimer);
  stopTimerBar();

  const elapsed = performance.now() - tokenShownAt;
  const isCorrect = pressedPos === activePos;

  let points;
  if (isCorrect) {
    points = config.basePoints * (1 - elapsed / lifetime);
    correctCount++;
    reactionTimes.push(elapsed);
  } else {
    points = -config.penaltyPoints * (elapsed / lifetime);
    wrongCount++;
  }

  totalScore += points;
  showFeedback(isCorrect ? 'correct' : 'wrong', points, elapsed);
  flashSlot(isCorrect ? activePos : pressedPos, isCorrect);
  adjustLifetime(isCorrect);
  nextRound();
}

function adjustLifetime(correct) {
  if (correct) {
    lifetime = Math.max(config.minLifetime, lifetime * config.speedupFactor);
  } else {
    lifetime = Math.min(config.maxLifetime, lifetime * config.slowdownFactor);
  }
  lifetime = Math.round(lifetime);
}

function showFeedback(type, points, elapsed) {
  const sign = points >= 0 ? '+' : '';
  const label = type === 'correct' ? 'Correct!'
              : type === 'wrong'   ? 'Wrong!'
              : 'Missed!';
  feedbackEl.textContent = `${label}  ${sign}${Math.round(points)} pts  (${Math.round(elapsed)} ms)`;
  feedbackEl.className = `feedback ${type}`;
  updateStats();
}

function flashSlot(pos, correct) {
  const cls = correct ? 'flash-correct' : 'flash-wrong';
  slots[pos].classList.add(cls);
  slots.forEach(s => s.classList.remove('active'));
  setTimeout(() => slots[pos].classList.remove(cls), config.interRoundMs);
}

function updateStats() {
  scoreEl.textContent = Math.round(totalScore);
  const total = config.numRounds > 0 ? config.numRounds : '\u221e';
  roundEl.textContent = `${currentRound}/${total}`;
  lifetimeEl.textContent = lifetime;
}

function nextRound() {
  waitingNext = true;
  activePos = -1;

  if (config.numRounds > 0 && currentRound >= config.numRounds) {
    setTimeout(() => endGame(), config.interRoundMs);
    return;
  }

  setTimeout(() => showToken(), config.interRoundMs);
}

// ── Start / End ──────────────────────────────────────────────────
function startGame() {
  gameRunning   = true;
  currentRound  = 0;
  totalScore    = 0;
  lifetime      = config.initialLifetime;
  correctCount  = 0;
  wrongCount    = 0;
  missCount     = 0;
  reactionTimes = [];
  activePos     = -1;
  responded     = false;
  waitingNext   = false;

  startBtn.textContent = 'Running...';
  startBtn.disabled = true;
  settingsBtn.disabled = true;
  gameoverOvl.classList.remove('open');
  resetUI();
  updateStats();
  showToken();
}

function endGame() {
  gameRunning = false;
  stopTimerBar();
  clearTimeout(roundTimer);
  resetUI();

  startBtn.textContent = 'Start Game';
  startBtn.disabled = false;
  settingsBtn.disabled = false;

  // Populate game-over
  const total = correctCount + wrongCount + missCount;
  const accuracy = total > 0 ? ((correctCount / total) * 100).toFixed(1) : '0.0';
  const avgTime = reactionTimes.length > 0
    ? Math.round(reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length)
    : '-';

  document.getElementById('go-score').textContent = Math.round(totalScore);
  document.getElementById('go-correct').textContent = correctCount;
  document.getElementById('go-wrong').textContent = wrongCount;
  document.getElementById('go-missed').textContent = missCount;
  document.getElementById('go-accuracy').textContent = accuracy + '%';
  document.getElementById('go-avgTime').textContent = avgTime === '-' ? '-' : avgTime + ' ms';

  gameoverOvl.classList.add('open');
}

// ── Event listeners ──────────────────────────────────────────────
startBtn.addEventListener('click', startGame);
playAgainBtn.addEventListener('click', startGame);

document.addEventListener('keydown', (e) => {
  // Close overlays on Escape
  if (e.key === 'Escape') {
    settingsOvl.classList.remove('open');
    if (gameoverOvl.classList.contains('open')) {
      gameoverOvl.classList.remove('open');
    }
    return;
  }

  const pos = KEY_MAP[e.key.toLowerCase()];
  if (pos !== undefined) {
    if (!gameRunning) {
      // Auto-start on first key press if not running
      startGame();
    } else {
      onKeyResponse(pos);
    }
  }
});

// ── Init ─────────────────────────────────────────────────────────
updateStats();
</script>
</body>
</html>
